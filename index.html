<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyloAI Expert - Asesor√≠a de Imagen Integral</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* --- ESTILOS MODERNOS Y RESPONSIVOS --- */
        :root {
            --primary-dark: #1a1a1a;
            --accent: #d4af37; /* Dorado elegante */
            --accent-hover: #b5952f;
            --bg-light: #f8f9fa;
            --card-white: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --shadow: 0 15px 35px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-light); color: var(--text-main); margin: 0; padding: 0; line-height: 1.6; }
        
        /* Header */
        header { background: var(--primary-dark); color: white; padding: 40px 20px; text-align: center; border-bottom: 4px solid var(--accent); }
        header h1 { margin: 0; font-size: 2.2rem; font-weight: 700; letter-spacing: 1px; }
        header p { margin-top: 10px; opacity: 0.8; font-weight: 300; }

        /* Estructura Principal */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        /* Panel de Control (Izquierda) */
        .control-panel { background: var(--card-white); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; }
        
        .section-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-dark); border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 20px; text-transform: uppercase; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full { grid-column: span 2; }
        
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        select, input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; transition: 0.3s; box-sizing: border-box; }
        select:focus, input:focus { border-color: var(--accent); outline: none; }

        /* √Årea de Imagen */
        .image-area { 
            position: relative; width: 100%; min-height: 350px; 
            border: 2px dashed #ccc; border-radius: var(--radius); 
            background: #fafafa; display: flex; align-items: center; justify-content: center;
            overflow: hidden; margin-bottom: 20px; transition: 0.3s;
        }
        .image-area.active { border-style: solid; border-color: var(--accent); }
        
        #imagePreview { max-width: 100%; max-height: 500px; display: none; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }

        .btn-action { 
            width: 100%; padding: 16px; background-color: var(--primary-dark); 
            color: var(--accent); border: none; border-radius: 8px; 
            font-size: 1.1rem; font-weight: 700; cursor: pointer; 
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-action:hover:not(:disabled) { background-color: black; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-action:disabled { background-color: #bdc3c7; color: #fff; cursor: not-allowed; }

        /* Panel de Resultados (Derecha) */
        .results-panel { display: none; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .result-card { background: var(--card-white); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; position: relative; overflow: hidden; }
        .result-card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--accent); }
        
        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .card-icon { font-size: 2rem; }
        .card-title { font-size: 1.4rem; font-weight: 700; margin: 0; color: var(--primary-dark); }
        
        .analysis-highlight { font-size: 1.1rem; font-weight: 600; color: var(--accent-hover); margin-bottom: 10px; display: block; }
        .analysis-text { font-size: 0.95rem; color: #555; margin-bottom: 15px; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag { background: var(--bg-light); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: var(--primary-dark); border: 1px solid #ddd; }

        .status-msg { text-align: center; font-size: 0.9rem; margin-top: 10px; font-weight: 600; }
        .loading { color: #e67e22; }
        .ready { color: #27ae60; }
        .error { color: #e74c3c; }

    </style>
</head>
<body>

    <header>
        <h1>StyloAI Expert</h1>
        <p>An√°lisis Biom√©trico & Asesor√≠a de Imagen Personalizada</p>
    </header>

    <div class="container">
        <div class="control-panel">
            <div class="section-title">1. Configuraci√≥n del Perfil</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>G√©nero (para estilo)</label>
                    <select id="genderInput">
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Altura (cm)</label>
                    <input type="number" id="heightInput" placeholder="Ej: 175">
                </div>
                <div class="form-group">
                    <label>Textura de Cabello</label>
                    <select id="hairTexture">
                        <option value="liso">Liso / Lacio</option>
                        <option value="ondulado">Ondulado (Waves)</option>
                        <option value="rizado">Rizado (Curls)</option>
                        <option value="crespo">Crespo / Afro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Biotipo (Aproximado)</label>
                    <select id="bodyType">
                        <option value="auto">Detectar / Promedio</option>
                        <option value="ectomorfo">Ectomorfo (Delgado/Largo)</option>
                        <option value="mesomorfo">Mesomorfo (Atl√©tico)</option>
                        <option value="endomorfo">Endomorfo (Estructura ancha)</option>
                    </select>
                </div>
            </div>

            <div class="section-title">2. Escaneo Facial</div>
            <div class="image-area" id="dropArea">
                <div id="placeholderText" style="text-align: center; color: #999;">
                    <span style="font-size: 2rem;">üì∑</span><br>
                    Toca o arrastra para subir foto
                </div>
                <img id="imagePreview" alt="Vista previa">
            </div>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            
            <button id="btnAnalyze" class="btn-action" onclick="performFullAnalysis()" disabled>
                Analizar Mi Imagen
            </button>
            <div id="statusMessage" class="status-msg loading">‚è≥ Cargando modelos de IA...</div>
        </div>

        <div id="resultsPanel" class="results-panel">
            
            <div class="result-card">
                <div class="card-header">
                    <span class="card-icon">üß†</span>
                    <h3 class="card-title">Diagn√≥stico Facial</h3>
                </div>
                <span id="faceShapeTitle" class="analysis-highlight">---</span>
                <p id="faceShapeDesc" class="analysis-text">Esperando an√°lisis...</p>
                <div class="tags-container" id="faceTags"></div>
            </div>

            <div class="result-card">
                <div class="card-header">
                    <span class="card-icon">‚úÇÔ∏è</span>
                    <h3 class="card-title">Corte & Estilismo</h3>
                </div>
                <span class="analysis-highlight">Cortes Recomendados:</span>
                <p class="analysis-text">Basado en la geometr√≠a de tu rostro y tu textura <strong id="resTexture"></strong>:</p>
                <ul id="haircutList" style="padding-left: 20px; color: #444;"></ul>
            </div>

            <div class="result-card">
                <div class="card-header">
                    <span class="card-icon">üëï</span>
                    <h3 class="card-title">Asesor√≠a de Vestimenta</h3>
                </div>
                <span id="fashionStyleTitle" class="analysis-highlight">Estilo Sugerido</span>
                <p id="bodyTypeDesc" class="analysis-text"></p>
                <p id="fashionAdvice" class="analysis-text"></p>
                <div class="tags-container" id="fashionTags"></div>
            </div>

            <div class="result-card">
                <div class="card-header">
                    <span class="card-icon">üß¥</span>
                    <h3 class="card-title">Rutina de Mantenimiento</h3>
                </div>
                <ul id="productList" style="list-style: none; padding: 0;"></ul>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN E INICIALIZACI√ìN ---
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';
        const btnAnalyze = document.getElementById('btnAnalyze');
        const statusMsg = document.getElementById('statusMessage');
        const imgUpload = document.getElementById('imageUpload');
        const dropArea = document.getElementById('dropArea');
        const imgPreview = document.getElementById('imagePreview');
        const placeholder = document.getElementById('placeholderText');

        // Cargar modelos de Face-API
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
        ]).then(startApp).catch(err => {
            console.error(err);
            statusMsg.innerText = "‚ùå Error: No se pudo cargar la IA. Verifica tu conexi√≥n.";
            statusMsg.className = "status-msg error";
        });

        function startApp() {
            statusMsg.innerText = "‚úÖ IA Calibrada y Lista.";
            statusMsg.className = "status-msg ready";
            btnAnalyze.disabled = false;
        }

        // --- MANEJO DE IMAGEN ---
        dropArea.addEventListener('click', () => imgUpload.click());
        imgUpload.addEventListener('change', handleImage);

        function handleImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imgPreview.src = event.target.result;
                    imgPreview.style.display = 'block';
                    placeholder.style.display = 'none';
                    dropArea.classList.add('active');
                    // Limpiar canvas previo si existe
                    const existingCanvas = document.querySelector('canvas');
                    if (existingCanvas) existingCanvas.remove();
                    // Ocultar resultados previos
                    document.getElementById('resultsPanel').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // --- L√ìGICA DE AN√ÅLISIS EXPERTO ---
        async function performFullAnalysis() {
            if (!imgPreview.src || imgPreview.style.display === 'none') return alert("Por favor sube una imagen primero.");

            statusMsg.innerText = "üîç Analizando biometr√≠a y proporciones...";
            statusMsg.className = "status-msg loading";
            btnAnalyze.disabled = true;

            // 1. Detecci√≥n Facial
            const detection = await faceapi.detectSingleFace(imgPreview, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            if (!detection) {
                statusMsg.innerText = "‚ö†Ô∏è No se detect√≥ rostro. Usa una foto frontal con buena luz.";
                statusMsg.className = "status-msg error";
                btnAnalyze.disabled = false;
                return;
            }

            // Dibujar Landmarks
            const canvas = faceapi.createCanvasFromMedia(imgPreview);
            dropArea.append(canvas);
            const displaySize = { width: imgPreview.width, height: imgPreview.height };
            faceapi.matchDimensions(canvas, displaySize);
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

            // 2. Procesar Datos Matem√°ticos
            const landmarks = detection.landmarks;
            const jawWidth = landmarks.getJawOutline()[16].x - landmarks.getJawOutline()[0].x;
            const faceHeight = landmarks.getChin().y - landmarks.getNose()[0].y; // Medida relativa
            const cheekWidth = landmarks.getJawOutline()[14].x - landmarks.getJawOutline()[2].x;
            
            const ratio = faceHeight / jawWidth;
            const cheekToJawRatio = cheekWidth / jawWidth;

            // 3. Obtener Datos del Formulario
            const userGender = document.getElementById('genderInput').value;
            const userHeight = parseInt(document.getElementById('heightInput').value) || 170; // Default 170
            const userTexture = document.getElementById('hairTexture').value;
            let userBodyType = document.getElementById('bodyType').value;

            // 4. Determinar Forma del Rostro
            let faceShape = "Ovalado";
            let shapeDesc = "";
            
            if (ratio > 1.45) {
                faceShape = "Alargado / Oblongo";
                shapeDesc = "Tu rostro tiene una estructura vertical dominante. El objetivo es a√±adir volumen a los lados para equilibrar.";
            } else if (ratio < 1.15) {
                if (cheekToJawRatio > 1.1) {
                    faceShape = "Redondo";
                    shapeDesc = "Tus facciones son suaves y el ancho es similar al largo. Buscamos √°ngulos y altura para estilizar.";
                } else {
                    faceShape = "Cuadrado";
                    shapeDesc = "Tienes una mand√≠bula fuerte y angular. El objetivo es suavizar las esquinas o potenciar la masculinidad (si aplica).";
                }
            } else if (cheekToJawRatio > 1.2) {
                faceShape = "Diamante / Coraz√≥n";
                shapeDesc = "P√≥mulos prominentes y barbilla afilada. Un rostro muy est√©tico que permite gran variedad de estilos.";
            } else {
                faceShape = "Ovalado";
                shapeDesc = "El 'Canon Ideal'. Tus proporciones est√°n equilibradas, permiti√©ndote usar casi cualquier estilo.";
            }

            // 5. Determinar Biotipo (Inferencia simple si est√° en auto)
            if (userBodyType === 'auto') {
                if (userHeight > 182 && ratio > 1.3) userBodyType = 'ectomorfo';
                else if (userHeight < 170 && faceShape === 'Redondo') userBodyType = 'endomorfo';
                else userBodyType = 'mesomorfo';
            }

            // --- GENERACI√ìN DE RESULTADOS ---
            generateOutputs(faceShape, shapeDesc, userGender, userTexture, userHeight, userBodyType);
            
            statusMsg.innerText = "‚úÖ An√°lisis Completado Exitosamente.";
            statusMsg.className = "status-msg ready";
            btnAnalyze.disabled = false;
        }

        function generateOutputs(shape, desc, gender, texture, height, bodyType) {
            // Rellenar Rostro
            document.getElementById('faceShapeTitle').innerText = shape;
            document.getElementById('faceShapeDesc').innerText = desc;
            
            const faceTags = document.getElementById('faceTags');
            faceTags.innerHTML = `
                <span class="tag">Simetr√≠a IA</span>
                <span class="tag">Biometr√≠a</span>
            `;

            // Rellenar Cabello
            document.getElementById('resTexture').innerText = texture;
            const cutsList = document.getElementById('haircutList');
            cutsList.innerHTML = "";
            
            const recommendations = getHairRecommendations(shape, texture, gender);
            recommendations.forEach(cut => {
                let li = document.createElement('li');
                li.innerHTML = `<strong>${cut.name}:</strong> ${cut.why}`;
                cutsList.appendChild(li);
            });

            // Rellenar Moda
            const fashionTitle = document.getElementById('fashionStyleTitle');
            const fashionDesc = document.getElementById('fashionAdvice');
            const bodyDesc = document.getElementById('bodyTypeDesc');
            
            const styleData = getFashionAdvice(bodyType, height, gender);
            
            fashionTitle.innerText = styleData.styleName;
            bodyDesc.innerHTML = `Detectado/Seleccionado: <strong>${capitalize(bodyType)}</strong> (Altura: ${height}cm)`;
            fashionDesc.innerText = styleData.advice;
            
            const fashionTags = document.getElementById('fashionTags');
            fashionTags.innerHTML = "";
            styleData.keywords.forEach(k => {
                let s = document.createElement('span');
                s.className = "tag"; s.innerText = k;
                fashionTags.appendChild(s);
            });

            // Rellenar Productos
            const prodList = document.getElementById('productList');
            prodList.innerHTML = "";
            const products = getProducts(texture, gender);
            
            products.forEach(p => {
                let li = document.createElement('li');
                li.style.marginBottom = "10px";
                li.innerHTML = `‚úîÔ∏è <strong>${p.name}:</strong> <span style="font-size:0.9em; color:#666;">${p.usage}</span>`;
                prodList.appendChild(li);
            });

            // Mostrar Panel
            document.getElementById('resultsPanel').style.display = 'block';
            document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
        }

        // --- BASES DE DATOS DE ESTILO (SIMULADAS) ---

        function getHairRecommendations(shape, texture, gender) {
            // L√≥gica simplificada de experto
            const isMale = gender === 'male';
            let cuts = [];

            if (isMale) {
                if (shape.includes("Ovalado")) cuts = [
                    { name: "Pompadour Cl√°sico", why: "Aprovecha tu simetr√≠a para dar volumen arriba." },
                    { name: "Undercut & Slick Back", why: "Look moderno que despeja el rostro." },
                    { name: "Buzz Cut", why: "Si tienes buena estructura √≥sea, esto resalta tus facciones." }
                ];
                else if (shape.includes("Cuadrado")) cuts = [
                    { name: "French Crop", why: "Suaviza la frente pero mantiene la masculinidad de la mand√≠bula." },
                    { name: "Side Part (Raya al lado)", why: "Cl√°sico y elegante para negocios." },
                    { name: "Textured Quiff", why: "Rompe la rigidez de las l√≠neas cuadradas." }
                ];
                else if (shape.includes("Redondo")) cuts = [
                    { name: "Fade Alto (Skin Fade)", why: "Elimina volumen lateral para alargar visualmente el rostro." },
                    { name: "Faux Hawk", why: "A√±ade altura en la coronilla, estilizando el perfil." },
                    { name: "Barba perfilada", why: "Crucial para crear √°ngulos en la mand√≠bula." }
                ];
                else cuts = [ // Alargado/Diamante
                    { name: "Fringe / Flequillo", why: "Acorta visualmente la frente (ideal para rostros largos)." },
                    { name: "Corte con tijera a los lados", why: "Evita rapar los lados para no alargar m√°s el rostro." }
                ];
            } else {
                // Female Logic
                if (shape.includes("Ovalado")) cuts = [
                    { name: "Long Bob (Lob)", why: "El corte m√°s vers√°til y chic." },
                    { name: "Capas Largas", why: "Da movimiento sin alterar la forma perfecta." }
                ];
                else if (shape.includes("Cuadrado")) cuts = [
                    { name: "Flequillo Cortina (Curtain Bangs)", why: "Suaviza los √°ngulos de la mand√≠bula." },
                    { name: "Largo y Liso", why: "Estiliza verticalmente." }
                ];
                else if (shape.includes("Redondo")) cuts = [
                    { name: "Pixie con volumen", why: "Alarga el cuello y estiliza." },
                    { name: "Side Swept Bangs", why: "Rompe la simetr√≠a redonda creando diagonales." }
                ];
                else cuts = [
                    { name: "Ondas estilo Hollywood", why: "A√±ade anchura lateral para rostros alargados." },
                    { name: "Bob a la altura de la barbilla", why: "Da volumen donde hace falta." }
                ];
            }
            return cuts;
        }

        function getFashionAdvice(biotype, height, gender) {
            const isMale = gender === 'male';
            
            if (biotype === 'ectomorfo') {
                return {
                    styleName: isMale ? "Layering & Streetwear" : "Volumen & Estructura",
                    advice: "Tu cuerpo tiende a ser delgado. El objetivo es crear volumen visual. Usa capas (camisa + sweater + chaqueta). Evita la ropa 'Skinny' extrema que resalta la delgadez. Los cortes 'Slim' o 'Regular' son ideales. Telas gruesas como denim pesado o lana te favorecen.",
                    keywords: ["Layering", "Oversized Controlado", "Cuellos Altos", "Rayas Horizontales"]
                };
            } else if (biotype === 'endomorfo') {
                return {
                    styleName: isMale ? "Smart Casual Minimalista" : "Monocrom√°tico Chic",
                    advice: "Buscas estilizar la figura. La ropa monocrom√°tica (un solo color o tonos similares) crea una l√≠nea vertical ininterrumpida que adelgaza. Evita estampados grandes. Opta por chaquetas estructuradas en los hombros para mejorar la postura.",
                    keywords: ["Monocrom√°tico", "Corte Recto", "Telas Mate", "Verticalidad"]
                };
            } else { // Mesomorfo
                return {
                    styleName: isMale ? "Fitted & Athletic" : "Resaltar Silueta",
                    advice: "Tienes una estructura atl√©tica natural. Tu ropa debe seguir la l√≠nea de tu cuerpo sin apretar demasiado. Las camisas entalladas y pantalones slim-tapered lucen excelente. Puedes experimentar con casi cualquier tendencia.",
                    keywords: ["Entallado", "Deportivo", "Vers√°til", "Ajuste Perfecto"]
                };
            }
        }

        function getProducts(texture, gender) {
            let products = [];
            // Base
            products.push({ name: "Shampoo s/Sulfatos", usage: "Base esencial para no resecar el cuero cabelludo." });

            if (texture === 'liso') {
                products.push({ name: "Polvo Voluminizador", usage: "Apl√≠calo en la ra√≠z seca para dar textura y levantar." });
                products.push({ name: "Cera Mate (Clay)", usage: "Fijaci√≥n fuerte sin brillo para un look natural." });
            } else if (texture === 'ondulado') {
                products.push({ name: "Spray de Sal Marina", usage: "Potencia las ondas naturales 'efecto playa'." });
                products.push({ name: "Pomada a base de agua", usage: "Control medio con un poco de brillo." });
            } else if (texture === 'rizado') {
                products.push({ name: "Crema para Peinar (Leave-in)", usage: "Hidrataci√≥n constante para definir el rizo." });
                products.push({ name: "Mousse Definidor", usage: "Evita el frizz sin dejar el pelo duro." });
            } else { // Crespo
                products.push({ name: "Aceites (Arg√°n/Coco)", usage: "Nutrici√≥n profunda diaria." });
                products.push({ name: "Manteca de Karit√©", usage: "Sellado de humedad." });
            }
            return products;
        }

        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    </script>
</body>
</html>
