<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyloAI - An√°lisis Facial Biom√©trico Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* --- ESTILOS (Mantenemos el dise√±o moderno) --- */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60; /* Verde tecnol√≥gico */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        header { text-align: center; padding: 40px 20px; background: var(--primary-color); color: white; margin-bottom: 20px; }
        header h1 { margin: 0; font-size: 2.5rem; }
        
        .input-section { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color); }
        select, input[type="number"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* Contenedor de imagen con Canvas superpuesto */
        .image-preview-container { 
            width: 100%; height: auto; min-height: 300px; 
            border: 2px dashed #ddd; border-radius: var(--border-radius); 
            display: flex; align-items: center; justify-content: center; 
            background-color: #fafafa; position: relative; overflow: hidden;
        }
        
        #imagePreview { max-width: 100%; display: none; border-radius: 8px; }
        /* El canvas se dibuja sobre la imagen para mostrar los puntos detectados */
        canvas { position: absolute; top: 0; left: 0; }

        .btn-analyze { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-analyze:hover { background-color: #34495e; }
        .btn-analyze:disabled { background-color: #95a5a6; cursor: not-allowed; }

        .results-section { display: none; }
        .result-card { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 25px; border-left: 5px solid var(--accent-color); animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .result-title { font-size: 1.4rem; color: var(--primary-color); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .highlight { font-weight: 700; color: var(--accent-color); font-size: 1.2rem; }
        .recommendation-list li { margin-bottom: 8px; }
        
        /* Estado de carga */
        #statusMessage { text-align: center; font-weight: 600; margin-top: 10px; color: #e67e22; }
    </style>
</head>
<body>

    <header>
        <h1>StyloAI Bio-Scan</h1>
        <p>An√°lisis de rostro real mediante Inteligencia Artificial</p>
    </header>

    <div class="container">
        <div class="input-section">
            <h2>Datos Biom√©tricos</h2>
            
            <div class="form-group">
                <label>1. Estado del Sistema</label>
                <div id="modelStatus" style="color: #e74c3c; font-size: 0.9rem;">‚è≥ Cargando modelos de IA... (Espera unos segundos)</div>
            </div>

            <div class="form-group">
                <label for="imageUpload">2. Sube tu foto (Frontal y con luz)</label>
                <div class="image-preview-container" id="previewContainer">
                    <span class="placeholder-text">Sube una foto clara</span>
                    <img id="imagePreview" alt="Tu foto">
                    </div>
                <input type="file" id="imageUpload" accept="image/*">
            </div>

            <div class="form-group">
                <label for="hairTexture">3. Tipo de Cabello</label>
                <select id="hairTexture">
                    <option value="liso">Liso</option>
                    <option value="ondulado">Ondulado</option>
                    <option value="rizado">Rizado</option>
                    <option value="crespo">Crespo / Afro</option>
                </select>
            </div>

            <button id="btnAnalyze" class="btn-analyze" onclick="startAnalysis()" disabled>Analizar Rostro</button>
            <p id="statusMessage"></p>
        </div>

        <div id="resultsColumn">
            <div id="resultsContainer" class="results-section">
                
                <div class="result-card">
                    <h3 class="result-title">üß† An√°lisis Biom√©trico Detectado</h3>
                    <p>Forma de Rostro: <span id="faceShapeResult" class="highlight">---</span></p>
                    <p id="faceAnalysisDetails" style="font-size: 0.9rem; color: #666;"></p>
                </div>

                <div class="result-card">
                    <h3 class="result-title">‚úÇÔ∏è Corte Recomendado</h3>
                    <ul class="recommendation-list" id="haircutList"></ul>
                </div>

                <div class="result-card">
                    <h3 class="result-title">üß¥ Productos Sugeridos</h3>
                    <ul class="recommendation-list" id="productList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN Y CARGA DE MODELOS ---
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const container = document.getElementById('previewContainer');
        const btnAnalyze = document.getElementById('btnAnalyze');
        const modelStatus = document.getElementById('modelStatus');
        
        // URL de los modelos (usando CDN p√∫blico compatible con CORS)
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';

        async function loadModels() {
            try {
                // Cargar solo el modelo TinyFace (r√°pido) y Landmarks (puntos faciales)
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                
                modelStatus.innerText = "‚úÖ Modelos de IA cargados. Listo para usar.";
                modelStatus.style.color = "#27ae60";
                btnAnalyze.disabled = false;
            } catch (error) {
                console.error(error);
                modelStatus.innerText = "‚ùå Error cargando IA. Verifica tu conexi√≥n a internet.";
            }
        }

        // Iniciar carga al abrir
        loadModels();

        // --- 2. MANEJO DE IMAGEN ---
        let canvas;
        
        imageUpload.addEventListener('change', async () => {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    document.querySelector('.placeholder-text').style.display = 'none';
                    
                    // Limpiar canvas anterior si existe
                    if (canvas) canvas.remove();
                };
                reader.readAsDataURL(file);
            }
        });

        // --- 3. L√ìGICA DE AN√ÅLISIS REAL ---
        async function startAnalysis() {
            if (!imagePreview.src) return alert("Sube una imagen primero.");
            
            document.getElementById('statusMessage').innerText = "üîç Escaneando geometr√≠a facial...";
            
            // Detecci√≥n
            // Usamos TinyFaceDetectorOptions para velocidad
            const detection = await faceapi.detectSingleFace(imagePreview, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            if (!detection) {
                document.getElementById('statusMessage').innerText = "‚ö†Ô∏è No se detect√≥ un rostro claro. Intenta otra foto.";
                return;
            }

            // Dibujar los puntos en la imagen (Feedback visual)
            if (canvas) canvas.remove();
            canvas = faceapi.createCanvasFromMedia(imagePreview);
            container.append(canvas);
            const displaySize = { width: imagePreview.width, height: imagePreview.height };
            faceapi.matchDimensions(canvas, displaySize);
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

            // --- C√ÅLCULOS MATEM√ÅTICOS DE PROPORCI√ìN ---
            const landmarks = detection.landmarks;
            const jawWidth = landmarks.getJawOutline()[16].x - landmarks.getJawOutline()[0].x;
            const faceHeight = landmarks.getChin().y - landmarks.getNose()[0].y; // Aprox desde cejas a barbilla
            
            // Obtener ancho de p√≥mulos (Cheekbones) - Puntos 1 y 15 aprox
            const cheekBoneWidth = landmarks.getJawOutline()[14].x - landmarks.getJawOutline()[2].x;
            
            // Ratio: Largo / Ancho
            const ratio = faceHeight / jawWidth;
            
            // Clasificaci√≥n Matem√°tica Simple
            let faceShape = "Indefinido";
            let description = "";

            // L√≥gica de clasificaci√≥n (Simplificada pero basada en medidas reales)
            if (ratio > 1.5) {
                faceShape = "OVALADO / ALARGADO";
                description = "Tu rostro es notablemente m√°s largo que ancho.";
            } else if (ratio < 1.15 && cheekBoneWidth > jawWidth * 1.1) {
                faceShape = "REDONDO / DIAMANTE";
                description = "El ancho y largo son similares, con p√≥mulos marcados o mejillas suaves.";
            } else if (ratio < 1.15) {
                faceShape = "CUADRADO";
                description = "Tienes una mand√≠bula fuerte y angular, con proporciones ancho/largo similares.";
            } else {
                faceShape = "OVALADO (Est√°ndar)";
                description = "Tus proporciones son equilibradas (ratio √°ureo cercano a 1.3-1.4).";
            }

            // Mostrar Resultados
            displayResults(faceShape, description);
            document.getElementById('statusMessage').innerText = "‚úÖ An√°lisis completado.";
        }

        // --- 4. GENERAR RECOMENDACIONES ---
        function displayResults(shape, desc) {
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('faceShapeResult').innerText = shape;
            document.getElementById('faceAnalysisDetails').innerText = desc;
            
            const texture = document.getElementById('hairTexture').value;
            generateRecommendations(shape, texture);
            
            document.getElementById('resultsColumn').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRecommendations(shape, texture) {
            const cutsList = document.getElementById('haircutList');
            const prodsList = document.getElementById('productList');
            cutsList.innerHTML = "";
            prodsList.innerHTML = "";

            let cuts = [];
            
            // L√≥gica combinada: Forma + Textura
            if (shape.includes("OVALADO")) {
                if (texture === "liso") cuts = ["Pompadour cl√°sico", "Undercut texturizado", "Buzz cut"];
                else if (texture === "rizado") cuts = ["Fade medio con rizos arriba", "Corte en capas sueltas"];
                else cuts = ["Corte C√©sar", "Taper Fade"];
            } else if (shape.includes("CUADRADO")) {
                cuts = ["Buzz cut (militar)", "Quiff alto (para alargar)", "French Crop"];
            } else if (shape.includes("REDONDO")) {
                cuts = ["Faux Hawk (para dar altura)", "Pompadour con volumen", "Laterales muy cortos (Skin Fade)"];
            } else {
                cuts = ["Flequillo texturizado", "Mullet moderno", "Corte medio desordenado"];
            }

            cuts.forEach(c => {
                let li = document.createElement('li');
                li.innerText = "‚úÇÔ∏è " + c;
                cutsList.appendChild(li);
            });

            // Productos seg√∫n textura
            let products = [];
            if (texture === "liso") products = ["Cera Mate", "Polvo de volumen"];
            if (texture === "ondulado") products = ["Spray de Sal Marina", "Pomada base agua"];
            if (texture === "rizado") products = ["Crema activadora de rizos", "Shampoo Low-Poo"];
            if (texture === "crespo") products = ["Aceite de Arg√°n", "Manteca de Karit√©", "Esponja Twist"];

            products.forEach(p => {
                let li = document.createElement('li');
                li.innerText = "üß¥ " + p;
                prodsList.appendChild(li);
            });
        }
    </script>
</body>
</html>